# Development Session: 2026-02-05

## Overview

Built the core NextJS/React frontend for ECOD (Evolutionary Classification of Protein Domains) as a replacement for the legacy PHP website. This is the second attempt at this migration - the first attempt had issues with React/WebGL conflicts in the 3D viewer.

## What Was Built

### 1. Database Connection
- PostgreSQL connection to `asteria:45000`, database `ecod_af2_pdb`, user `ecodweb`
- Connection pool with typed query helper (`src/lib/db.ts`)
- TTL-based cache for expensive queries (`src/lib/cache.ts`)

### 2. Home Page (`/`)
- Live stats display showing:
  - Total domains (2.6M)
  - Families (20K F-groups)
  - Domains from PDB (1.1M experimental)
  - Domains from AFDB (1.5M computed)
- Search bar for quick access
- Navigation links to tree, search, documentation, downloads

### 3. Tree Navigation (`/tree`)
- Hierarchical browser for ECOD classification: A → X → H → T → F
- Lazy-loading via `/api/tree?parentId=X`
- Color-coded level badges (A=purple, X=blue, H=green, T=yellow, F=orange)
- Expandable nodes with domain counts
- Client-side caching of loaded nodes

### 4. Search (`/search`)
- Auto-detection of search type from query string:
  - UID: pure numbers (e.g., "89", "000000089")
  - Domain ID: starts with 'e' + 4 chars (e.g., "e1e0tA1")
  - Cluster ID: numbers with dots (e.g., "1.1.15", "1.1.15.1")
  - PDB ID: 4 chars starting with digit (e.g., "1e0t") - case insensitive
  - UniProt: standard accession pattern (e.g., "P12345")
  - Keyword: everything else (searches cluster names)
- Pagination support
- Results show both matching clusters and domains
- Table view with links to domain pages and external resources

### 5. Domain Detail Page (`/domain/[uid]`)
- Full domain information:
  - Domain ID, UID, type (PDB/AlphaFold), range
  - Classification hierarchy with links to tree view
  - Protein info from UniProt (name, gene)
  - External links (RCSB, PDBe, UniProt)
  - Download buttons (domain PDB, FASTA)
- 3D Structure Viewer (see below)

### 6. 3D Structure Viewer
**Key Decision**: Use iframe isolation to avoid React/WebGL conflicts that plagued the previous attempt.

- Standalone HTML page at `/public/viewer/index.html`
- Uses PDBe Mol* (same viewer as RCSB PDB)
- Two view modes:
  - **Domain** (default): Loads pre-cut domain PDB from `/api/domain/[uid]/pdb`
  - **In Context**: Loads full PDB from RCSB with domain highlighted in orange
- Controls: Reset, Spin toggle
- Mol*'s default viewport controls hidden via CSS

**Domain PDB Files**: Pre-cut domain structures exist at:
```
/data/ECOD0/html/af2_pdb_d/{mid}/{padded_uid}/{padded_uid}.pdb
```
Where `mid` = first 5 chars of 9-digit padded UID.

Also available: `.fa` (FASTA), `.png` images (domain, chain context, PDB context).

### 7. API Endpoints

| Endpoint | Purpose |
|----------|---------|
| `GET /api/stats` | Database statistics from `info` table |
| `GET /api/tree?parentId=X` | Children of cluster X (or root if empty) |
| `GET /api/tree/domains?clusterId=X` | Representative domains in cluster |
| `GET /api/search?q=X&page=N` | Search with auto-detection |
| `GET /api/domain/[uid]` | Full domain details + classification |
| `GET /api/domain/[uid]/pdb` | Pre-cut domain PDB file |

## Technical Decisions

### Why Iframe for 3D Viewer?
The previous NextJS attempt had issues with Mol*/NGL viewers conflicting with React's DOM management. The iframe approach:
- Completely isolates WebGL context from React
- Viewer can crash without affecting main app
- Simple message-passing API for parent-child communication
- Standard pattern used by many molecular visualization sites

### Database Schema Notes
- Domain types stored as enum: `'experimental structure'` and `'computed structural model'`
- Classification hierarchy: cluster table with `parent` references
- Cluster types: 'A' (Architecture), 'X', 'H', 'T', 'F' (Family)
- Level determined by dot count in ID: 0=X, 1=H, 2=T, 3=F
- UID padded to 9 digits in file paths: `str_pad($uid, 9, '0', STR_PAD_LEFT)`

### Search Type Detection
```typescript
// Order matters - more specific patterns first
1. Domain ID: /^e[0-9a-z]{4}/i
2. Cluster ID: /^\d+\.\d+(\.\d+)*$/  (must have dots)
3. UID: /^\d+$/  (pure number, no dots)
4. PDB ID: /^[0-9][a-z0-9]{3}$/i  (exactly 4 chars)
5. UniProt: standard accession patterns
6. Keyword: fallback
```

## Files Created

```
src/
├── app/
│   ├── api/
│   │   ├── domain/[uid]/
│   │   │   ├── route.ts        # Domain details API
│   │   │   └── pdb/route.ts    # Domain PDB file serving
│   │   ├── search/route.ts     # Search API
│   │   ├── stats/route.ts      # Stats API
│   │   └── tree/
│   │       ├── route.ts        # Tree children API
│   │       └── domains/route.ts # Cluster domains API
│   ├── domain/[uid]/page.tsx   # Domain detail page
│   ├── search/page.tsx         # Search page
│   ├── tree/page.tsx           # Tree browser page
│   ├── distribution/page.tsx   # Downloads (placeholder)
│   ├── documentation/page.tsx  # Docs (placeholder)
│   ├── layout.tsx              # Root layout with header/footer
│   └── page.tsx                # Home page
├── components/
│   ├── layout/
│   │   ├── Header.tsx          # Site header with nav
│   │   └── Footer.tsx          # Site footer
│   ├── search/
│   │   └── SearchBar.tsx       # Reusable search input
│   ├── tree/
│   │   ├── TreeView.tsx        # Tree container with caching
│   │   └── TreeNode.tsx        # Expandable tree node
│   ├── ui/
│   │   └── StatsDisplay.tsx    # Stats cards component
│   └── viewer/
│       └── StructureViewer.tsx # Iframe wrapper for Mol*
├── lib/
│   ├── db.ts                   # PostgreSQL connection pool
│   └── cache.ts                # TTL-based memory cache
└── types/
    └── ecod.ts                 # TypeScript interfaces

public/
└── viewer/
    └── index.html              # Standalone Mol* viewer

docs/
├── LEGACY_PHP_ANALYSIS.md      # PHP site analysis
├── DATABASE_SCHEMA.md          # Database tables/views
├── PREVIOUS_NEXTJS_ATTEMPT.md  # Why first attempt failed
├── IMPLEMENTATION_DETAILS.md   # Patterns and configs
├── DATA_STRUCTURES.md          # TypeScript interfaces
└── MIGRATION_CHECKLIST.md      # Migration tasks
```

## Known Issues / TODO

1. **AlphaFold domains**: Viewer supports them (`af` parameter) but not fully tested
2. **Download endpoints**: `/api/domain/[uid]/fasta` not implemented yet
3. **Distribution page**: Placeholder only
4. **Documentation page**: Placeholder only
5. **Domain images**: Pre-rendered PNGs exist but not served yet
6. **PDB info**: `pdb_chain` table query fails silently (table may not exist)

## Environment Setup

```bash
# Load Node.js
module load node-23.8.0

# Install dependencies
npm install

# Create .env.local with database credentials
cp .env.example .env.local
# Edit .env.local with actual password

# Run dev server
npm run dev
# Server runs on port 3002 (or next available)
```

## Testing URLs

- Home: http://localhost:3002/
- Search: http://localhost:3002/search?q=kinase
- Tree: http://localhost:3002/tree
- Domain: http://localhost:3002/domain/89
- Viewer standalone: http://localhost:3002/viewer/index.html?uid=89&pdb=1e0t&range=A:70-167&domain=e1e0tA1

## Git Commit

```
46ac763 Add core ECOD frontend: search, tree navigation, domain pages with 3D viewer
```
35 files changed, 6953 insertions
